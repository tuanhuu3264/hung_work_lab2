<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie App</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/vue-router@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="db-provider.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        
        <div class="container">
            <div class="container-header">
                <div id="header" class="header">
                    <p id="header-mssv">MSSV: 12345678</p>
                    <h3 id="header-title">Movies Info</h3>
                    <div class="header-change-mode">
                        <label class="toggle-switch">
                            <input type="checkbox" id="modeToggle"  v-model="darkMode" @change="toggleDarkMode">
                            <span class="slider"></span>
                        </label>
                        </label>
                    </div>
                </div>
                <div id="nav" class="container-nav">
                    <img src="icons/icons8-home.svg" @click="homeRedirect" alt="icon-home" id="icon-home" style="width: 24px;" />
                    <div class="search-tool">
                        <input id="search-text" type="text" placeholder="Search movies..." v-model="searchQuery" />
                        <button id="search-button" @click="searchMovies" class="btn-search">Search</button>
                    </div>
                </div>
            </div>
            
            <div class="container-body">
                <div>
                    <div v-if="loading">Loading...</div>
                    <div v-else-if="error">{{ error }}</div>
                    <div v-else>
                       <div class="basic-information-container">
                        <img class="revenueItemImg" :src="movie.image" class="d-block w-30" :alt="movie.fullTitle">
                        <div class="basic-information">
                            <div class="basic-information-item">
                                <h4>Full Title:</h4>
                                <p>{{ movie?.fullTitle}}</p>
                            </div>
                            <div class="basic-information-item">
                                <h4>Genre: </h4>
                                <p>{{ movie?.genre}}</p>
                            </div>
                            <div class="basic-information-item">
                                <h4>Directors: </h4>
                                <p>{{ movie?.directors}}</p>
                            </div>
                            <div class="basic-information-item">
                                <h4>Writers: </h4>
                                <p>{{ movie?.writers}}</p>
                            </div>
                            <div class="basic-information-item">
                                <h4>Release Date: </h4>
                                <p>{{ movie?.releaseDate}}</p>
                            </div>
                            <div class="basic-information-item">
                                <h4>Run Time: </h4>
                                <p>{{ movie?.runtimeStr}}</p>
                            </div>
                            <div class="basic-information-item">
                                <h4>Plot: </h4>
                                <p>{{ movie?.plot}}</p>
                            </div>
                            <div class="basic-information-item">
                                <h4>Companies: </h4>
                                <p>{{ movie?.companies}}</p>
                            </div>
                            <div class="basic-information-item">
                                <h4>Languages: </h4>
                                <p>{{ movie?.languages}}</p>
                            </div>
                        </div>
                       </div>

                       <h3>Actors</h3>
                        
                    <div id="actorCarousel" class="carousel slide" data-ride="carousel">
                        <div class="carousel-inner top-rating-caursol-inner">
                            <div class="carousel-item top-rating-caursol-item" v-for="(chunk, chunkIndex) in chunkActors(actors)"
                                :class="{ active: chunkIndex === 0 }" :key="chunkIndex">
                                <div class="d-flex justify-content-around">
                                    <div v-for="(actor, index) in chunk" :key="actor.id" class="top-rating-movie-item">
                                        <img :src="actor.image" class="d-block w-30" :alt="actor.name">
                                        <div class=" mt-3">
                                            <h4>{{ actor?.name }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <a class="carousel-control-prev" href="#actorCarousel" role="button" data-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="sr-only">Previous</span>
                        </a>
                        <a class="carousel-control-next" href="#actorCarousel" role="button" data-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="sr-only">Next</span>
                        </a>
                    </div>
                    
                     <h3>Reviews</h3>
                      <div>
                        <div class="review-container" v-for="(review, index) in reviews" :class="{ active: index === 0 }" :key="review.id">
                            <div class="review-item">
                                <p><span>{{ review.username }}</span> - {{ review.date }}</p>
                                <h2>{{ review.title }}</h2> 
                                <div class="star-rating">
                                    <span class="star fa fa-star" :class="{'checked': review.rate >= 2}"></span>
                                    <span class="star fa fa-star" :class="{'checked': review.rate >= 4}"></span>
                                    <span class="star fa fa-star" :class="{'checked': review.rate >= 6}"></span>
                                    <span class="star fa fa-star" :class="{'checked': review.rate >= 8}"></span>
                                    <span class="star fa fa-star" :class="{'checked': review.rate >= 10}"></span>
                                </div>
                                <p>{{ review.content }}</p>
                            </div>
                        </div>
                    </div>

                    </div>
            </div>
        </div>
    </div>
 
    <script type="module">
        import { HomePage } from './pages/home-page.js';
        import { SearchPage } from './pages/search-page.js';
        let searchQuery = "";
        const homePage = HomePage;
        const searchPage = SearchPage;
        const DetailPage = {
            template: `
              <div>
                <h1>Detail Page</h1>
                <p>Movie ID: {{ $route.params.id }}</p>
              </div>
            `
        };
        const routes = [
            { path: "/", component: homePage },
            { path: "/search", component: searchPage },
            { path: "/detail/:id", component: DetailPage }
        ];

        const router = VueRouter.createRouter({
            history: VueRouter.createWebHashHistory(),
            routes
        });

        const app = Vue.createApp({
            data() {
                return {
                    loading: true,
                    error: null,
                    darkMode: false,
                    actors: [],
                    movies: [],
                    movie: {},
                    reviews: [],
                };
            },
            created() {
                this.fetchMovies();
                this.fetchReviews();
            },
            methods: {
                 toggleDarkMode() {
                    if (this.darkMode) {
                        document.body.classList.remove('light-mode');
                        document.body.classList.add('dark-mode');
                        document.getElementById("header").classList.add("header-dark-mode"); 
                        document.getElementById("footer").classList.add("footer-dark-mode"); 
                        document.getElementById("nav").classList.add("nav-dark-mode");
                        document.getElementById("search-button").classList.add("btn-search-dark");
                        document.getElementById("search-text").classList.add("search-text-dark");
                        document.getElementById("icon-home").setAttribute("src", "icons/icons8-home-white.svg");

                    } else {
                        document.body.classList.remove('dark-mode');
                        document.body.classList.add('light-mode');
                        document.getElementById("header").classList.remove("header-dark-mode"); 
                        document.getElementById("nav").classList.remove("nav-dark-mode"); 
                        document.getElementById("footer").classList.remove("footer-dark-mode"); 
                        document.getElementById("search-button").classList.remove("btn-search-dark");
                        document.getElementById("search-text").classList.remove("search-text-dark");
                        document.getElementById("icon-home").classList.remove("icon-dark-mode");
                         document.getElementById("icon-home").setAttribute("src", "icons/icons8-home.svg");
                    }
                }, 
                searchMovies() {
                    this.$router.push({ path: '/search', query: { searchQuery: this.searchQuery } });
                },
                 homeRedirect() {
                    this.$router.push({ path: '/' });
                },
                searchMoviesReplace() {
                    this.$router.replace({ path: this.$route.path, query: { searchQuery: this.searchQuery } });
                },
                chunkActors(array) {
                    let size = 3;
                    return Array.from(
                        { length: Math.ceil(array?.length / size) },
                        (_, index) => array.slice(index * size, index * size + size)
                    );
                },
                async fetchMovies() {
                    this.loading = true;
                    const url = "http://matuan.online:2422/api/Movies";
                    try {
                        const data = await callApi(url, "GET");
                        this.movies = data;
                        const movieData = this.movies.find((movie) => movie.id === "tt0012349");

                        if (movieData) {
                            this.movie = {
                                ...movieData,
                                genre: Array.isArray(movieData.genreList) ? movieData.genreList.map((genre) => genre.value).join(", ") : '',
                                actors: movieData.actorList || [],
                                directors: Array.isArray(movieData.directorList) ? movieData.directorList.map((director) => director.name).join(", ") : '',
                                writers: Array.isArray(movieData.writerList) ? movieData.writerList.map((writer) => writer.name).join(", ") : '',
                            };
                            this.actors = this.movie.actors;
                   
                        }
                    } catch (error) {
                        this.error = error;
                        console.error("Có lỗi xảy ra khi lấy dữ liệu:", error);
                    } finally {
                        this.loading = false;
                    }
                },
                 async fetchReviews() {
                    this.loading = true;
                    const url = "http://matuan.online:2422/api/Reviews";
                    try {
                        const data = await callApi(url, "GET");
                        this.reviews = data;
                        const reviewsData = this.reviews.find((review) => review.movieId === "tt0012349");

                        if (reviewsData) {
                            this.reviews = reviewsData.items;
                        }
                    } catch (error) {
                        this.error = error;
                        console.error("Có lỗi xảy ra khi lấy dữ liệu:", error);
                    } finally {
                        this.loading = false;
                    }
                },
            },
            watch: {
                searchQuery() {
                    this.searchMoviesReplace();
                }
            },
            router
        });

        app.use(router).mount("#app");
    </script>
   
</body>
<footer>
    <div id="footer" class="footer">
        <p>Thai Nguyen Viet Hung</p>
    </div>
</footer>

</html>