<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie App</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/vue-router@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="db-provider.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        
        <div class="container">
            <div class="container-header">
                <div id="header" class="header">
                    <p id="header-mssv">MSSV: 12345678</p>
                    <h3 id="header-title">Movies Info</h3>
                    <div class="header-change-mode">
                        <label class="toggle-switch">
                            <input type="checkbox" id="modeToggle"  v-model="darkMode" @change="toggleDarkMode">
                            <span class="slider"></span>
                        </label>
                        </label>
                    </div>
                </div>
                <div id="nav" class="container-nav">
                    <img src="icons/icons8-home.svg" alt="icon-home" id="icon-home" style="width: 24px;" />
                    <div class="search-tool">
                        <input id="search-text" type="text" placeholder="Search movies..." v-model="searchQuery" />
                        <button id="search-button" @click="searchMovies" class="btn-search">Search</button>
                    </div>
                </div>
                <div class="container-body container">
                    <div class="row">
                        <div class="col-12 col-sm-6 col-md-4 col-lg-3 mb-4" v-for="(movie, index) in movies" :key="movie.id">
                            <div class="item-search-container">
                                <img :src="movie.image" alt="Movie Image" />
                                <div class="info-card">
                                    <h4>{{ movie.fullTitle }}</h4>
                                    <p>Animation, Adventure, Drama</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
     
           
            </div>
        </div>
    </div>
 
    <script>
        let searchQuery = "";

        const HomePage = {
                data() {
                return {
                    loading: true,
                    error: null,
                    darkMode: false,
                    movies: [],
                    topRevenueMovies: [],
                    searchQuery: "",
                    topRatingMovies: [],
                    participants: [],
                    reviews: [],
                    mostPopularMovies: [],
                 };
                },
                created() {
                this.fetchMostPopularMovies();
                this.fetchTop50Movies();
                this.fetchMovies();
                 },
                template: ` <div class="container-body">
                <div>
                <div v-if="loading">Loading...</div>
                <div v-else-if="error">{{ error }}</div>
                <div id="movieCarousel" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item" v-for="(movie, index) in topRevenueMovies" :class="{ active: index === 0 }"
                            :key="movie.id">
                            <div class="d-flex justify-content-center">
                                <img class="revenueItemImg" :src="movie.image" class="d-block w-30" :alt="movie.fullTitle">
                                <div class="movie-info movie-overlay mt-3" >
                                    <h4>{{ movie?.fullTitle }}</h4>
                                    <p>{{ movie?.genre}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a class="carousel-control-prev" href="#movieCarousel" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#movieCarousel" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
                <h3 class="title-caursol">Most Popular</h3>
                <div id="movieMostPopularCarousel" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner top-rating-caursol-inner">
                        <div class="carousel-item top-rating-caursol-item" v-for="(chunk, chunkIndex) in chunkMovies(mostPopularMovies)"
                            :class="{ active: chunkIndex === 0 }" :key="chunkIndex">
                            <div class="d-flex justify-content-around">
                                <div v-for="(movie, index) in chunk" :key="movie.id" class="top-rating-movie-item">
                                    <img :src="movie.image" class="d-block w-30" :alt="movie.fullTitle">
                                    <div class="mt-3 movie-info-popup">
                                        <h4>{{ movie?.fullTitle }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a class="carousel-control-prev" href="#movieMostPopularCarousel" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#movieMostPopularCarousel" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
                <h3 class="title-caursol">Top Rating</h3>
                <div id="movieRatingCarousel" class="carousel slide" data-ride="carousel">
                    <div class="carousel-inner top-rating-caursol-inner">
                        <div class="carousel-item top-rating-caursol-item" v-for="(chunk, chunkIndex) in chunkMovies(topRatingMovies)"
                            :class="{ active: chunkIndex === 0 }" :key="chunkIndex">
                            <div class="d-flex justify-content-around">
                                <div v-for="(movie, index) in chunk" :key="movie.id" class="top-rating-movie-item">
                                    <img :src="movie.image" class="d-block w-30" :alt="movie.fullTitle">
                                    <div class=" mt-3 movie-info-popup" >
                                        <h4>{{ movie?.fullTitle }}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a class="carousel-control-prev" href="#movieRatingCarousel" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#movieRatingCarousel" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>`,
            methods:{
                chunkMovies(array) {
                    let size = 3;
                    return Array.from({ length: Math.ceil(array.length / size) }, (_, index) =>
                        array.slice(index * size, index * size + size)
                    );
                },
                async fetchTop50Movies() {
                    this.loading = true;
                    const url = "http://matuan.online:2422/api/Top50Movies";
                    try {
                        const data = await callApi(url, "GET");
                        this.topRatingMovies = data.slice(0, 30);;
                    } catch (error) {
                        this.error = error;
                        console.error("Có lỗi xảy ra khi lấy dữ liệu:", error);
                    } finally {
                        this.loading = false;
                    }
                },

                async fetchMostPopularMovies() {
                    this.loading = true;
                    const url = "http://matuan.online:2422/api/MostPopularMovies";
                    try {
                        const data = await callApi(url, "GET");
                        this.mostPopularMovies = data.slice(0, 30);;
                    } catch (error) {
                        this.error = error;
                        console.error("Có lỗi xảy ra khi lấy dữ liệu:", error);
                    } finally {
                        this.loading = false;
                    }
                },
                async  fetchMovies() {
                this.loading = true;
                const url = "http://matuan.online:2422/api/Movies";
                try {
                const data = await callApi(url, "GET");
                this.movies = data;
                this.topRevenueMovies = this.movies.sort((a,b) => a.imDbRatingCount - b.imDbRatingCount).slice(0, 5);
                } catch(error) {
                this.error = error;
                console.error("Có lỗi xảy ra khi lấy dữ liệu:", error);
                } finally {
                this.loading = false;
                }
                },
                
            },
            };

        const SearchPage = {
            template: `
              <div>
                <h1>Search Results</h1>
                <ul>
                  <li v-for="(item, index) in filteredItems" :key="index">{{ item }}</li>
                </ul>
              </div>
            `,
            data() {
                return {
                    searchQuery: "",
                    items: ["Inception", "Interstellar", "Avengers", "The Dark Knight"]
                };
            },
           
        };

        const DetailPage = {
            template: `
              <div>
                <h1>Detail Page</h1>
                <p>Movie ID: {{ $route.params.id }}</p>
              </div>
            `
        };

        const routes = [
            { path: "/", component: HomePage },
            { path: "/search", component: SearchPage },
            { path: "/detail/:id", component: DetailPage }
        ];

        const router = VueRouter.createRouter({
            history: VueRouter.createWebHashHistory(),
            routes
        });

        const app = Vue.createApp({
            data() {
                return {
                    loading: true,
                    error: null,
                    darkMode: false,
                    movies: [],
                    searchQuery: "",
                    page: 1,
                    per_page: 6,
                };
            },
              created() {
                this.fetchMovies();
                this.page = this.$route.query.page || 1;
                this.per_page = this.$route.query.per_page || 6;
                this.searchQuery = this.$route.query.searchQuery || "";
                this.searchMovies(this.searchQuery, this.page, this.per_page);
            },
            methods: {
                 toggleDarkMode() {
                    if (this.darkMode) {
                        document.body.classList.remove('light-mode');
                        document.body.classList.add('dark-mode');
                        document.getElementById("header").classList.add("header-dark-mode"); 
                        document.getElementById("footer").classList.add("footer-dark-mode"); 
                        document.getElementById("nav").classList.add("nav-dark-mode");
                        document.getElementById("search-button").classList.add("btn-search-dark");
                        document.getElementById("search-text").classList.add("search-text-dark");
                        document.getElementById("icon-home").setAttribute("src", "icons/icons8-home-white.svg");

                    } else {
                        document.body.classList.remove('dark-mode');
                        document.body.classList.add('light-mode');
                        document.getElementById("header").classList.remove("header-dark-mode"); 
                        document.getElementById("nav").classList.remove("nav-dark-mode"); 
                        document.getElementById("footer").classList.remove("footer-dark-mode"); 
                        document.getElementById("search-button").classList.remove("btn-search-dark");
                        document.getElementById("search-text").classList.remove("search-text-dark");
                        document.getElementById("icon-home").classList.remove("icon-dark-mode");
                         document.getElementById("icon-home").setAttribute("src", "icons/icons8-home.svg");
                    }
                }, 
                debounce(func, delay) {
                    let timeout;
                    return (...args) => {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func(...args), delay);
                    };
                },
                searchMovies() {
                    const query = this.searchQuery.toLowerCase();
                    this.filteredMovies = this.movies.filter(
                        movie =>
                            movie.fullTitle.toLowerCase().includes(query) ||
                            (movie.actorList || []).some(actor =>
                                actor.name.toLowerCase().includes(query)
                            )
                    );
                },
                async fetchMovies() {
                    this.loading = true;
                    const url = "http://matuan.online:2422/api/Movies";
                    try {
                        const data = await callApi(url, "GET");
                        this.movies = data;
                    } catch (error) {
                        this.error = error;
                        console.error("Có lỗi xảy ra khi lấy dữ liệu:", error);
                    } finally {
                        this.loading = false;
                    }
                },
                watch: {
                    searchQuery: {
                        handler: function (newQuery) {
                            this.debounce(this.searchMovies, 300)(newQuery);
                        },
                        immediate: true,
                    },
                },
                
            },
            router
        });

        app.use(router).mount("#app");
    </script>
   
</body>
<footer>
    <div id="footer" class="footer">
        <p>Thai Nguyen Viet Hung</p>
    </div>
</footer>

</html>